package cn.meshed.cloud.workflow.engine.gateway;

import cn.hutool.core.util.StrUtil;
import cn.meshed.cloud.workflow.ProviderApplication;
import cn.meshed.cloud.workflow.domain.engine.CreateDeployment;
import cn.meshed.cloud.workflow.domain.engine.gateway.DeploymentGateway;
import org.flowable.bpmn.converter.BpmnXMLConverter;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;

/**
 * <h1></h1>
 *
 * @author Vincent Vic
 * @version 1.0
 */
@SpringBootTest(classes = ProviderApplication.class)
@RunWith(SpringRunner.class)
public class DeploymentGatewayTest {

    @Autowired
    private DeploymentGateway deploymentGateway;

    @Test
    public void deployment() {
        CreateDeployment createDeployment = new CreateDeployment();
        createDeployment.setName("xxx");
        createDeployment.setKey("Test");
        createDeployment.setCategory("xxx");
        createDeployment.setXml("<?xml version=\"1.0\" encoding=\"UTF-8\"?><definitions xmlns=\"http://www.omg.org/spec/BPMN/20100524/MODEL\"             xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"             xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"             xmlns:bpmndi=\"http://www.omg.org/spec/BPMN/20100524/DI\"             xmlns:omgdc=\"http://www.omg.org/spec/DD/20100524/DC\"             xmlns:omgdi=\"http://www.omg.org/spec/DD/20100524/DI\"             xmlns:flowable=\"http://flowable.org/bpmn\"             typeLanguage=\"http://www.w3.org/2001/XMLSchema\"             expressionLanguage=\"http://www.w3.org/1999/XPath\"             targetNamespace=\"http://www.flowable.org/processdef\">    <process id=\"oa_leave_1\" name=\"OA 请假\" isExecutable=\"true\">        <startEvent id=\"startEvent\"/>        <sequenceFlow sourceRef=\"startEvent\" targetRef=\"approveTask\"/>        <userTask id=\"approveTask\" name=\"Approve or reject request\"/>        <sequenceFlow sourceRef=\"approveTask\" targetRef=\"decision\"/>        <exclusiveGateway id=\"decision\"/>        <sequenceFlow sourceRef=\"decision\" targetRef=\"externalSystemCall\">            <conditionExpression xsi:type=\"tFormalExpression\">                <![CDATA[          ${approved}        ]]>            </conditionExpression>        </sequenceFlow>        <sequenceFlow  sourceRef=\"decision\" targetRef=\"sendRejectionMail\">            <conditionExpression xsi:type=\"tFormalExpression\">                <![CDATA[          ${!approved}        ]]>            </conditionExpression>        </sequenceFlow>        <serviceTask id=\"externalSystemCall\" name=\"Enter holidays in external system\"                     flowable:class=\"org.flowable.CallExternalSystemDelegate\"/>        <sequenceFlow sourceRef=\"externalSystemCall\" targetRef=\"holidayApprovedTask\"/>        <userTask id=\"holidayApprovedTask\" name=\"Holiday approved\"/>        <sequenceFlow sourceRef=\"holidayApprovedTask\" targetRef=\"approveEnd\"/>        <serviceTask id=\"sendRejectionMail\" name=\"Send out rejection email\"                     flowable:class=\"org.flowable.SendRejectionMail\"/>        <sequenceFlow sourceRef=\"sendRejectionMail\" targetRef=\"rejectEnd\"/>        <endEvent id=\"approveEnd\"/>        <endEvent id=\"rejectEnd\"/>    </process>    <bpmndi:BPMNDiagram id=\"BPMNDiagram_transactional-collapsed-subprocess\">        <bpmndi:BPMNPlane bpmnElement=\"transactional-collapsed-subprocess\" id=\"BPMNPlane_transactional-collapsed-subprocess\">            <bpmndi:BPMNShape bpmnElement=\"startEvent\" id=\"BPMNShape_startEvent\">                <omgdc:Bounds height=\"30.0\" width=\"30.0\" x=\"100.0\" y=\"163.0\"></omgdc:Bounds>            </bpmndi:BPMNShape>            <bpmndi:BPMNShape bpmnElement=\"sid-D1AA9503-1CA6-4F7C-BE57-C3FB55F87443\" id=\"BPMNShape_sid-D1AA9503-1CA6-4F7C-BE57-C3FB55F87443\">                <omgdc:Bounds height=\"28.0\" width=\"28.0\" x=\"765.0\" y=\"162.0\"></omgdc:Bounds>            </bpmndi:BPMNShape>            <bpmndi:BPMNShape bpmnElement=\"transactionalCollapsedSubprocess\" id=\"BPMNShape_transactionalCollapsedSubprocess\" isExpanded=\"false\">                <omgdc:Bounds height=\"80.0\" width=\"100.0\" x=\"525.0\" y=\"136.0\"></omgdc:Bounds>            </bpmndi:BPMNShape>            <bpmndi:BPMNShape bpmnElement=\"transactionalSubprocess\" id=\"BPMNShape_transactionalSubprocess\">                <omgdc:Bounds height=\"160.0\" width=\"200.0\" x=\"195.0\" y=\"98.0\"></omgdc:Bounds>            </bpmndi:BPMNShape>            <bpmndi:BPMNEdge bpmnElement=\"sid-ACFA6668-EA33-4776-8C6B-A719753B834C\" id=\"BPMNEdge_sid-ACFA6668-EA33-4776-8C6B-A719753B834C\">                <omgdi:waypoint x=\"129.94999943586103\" y=\"178.0\"></omgdi:waypoint>                <omgdi:waypoint x=\"194.9999999999357\" y=\"178.0\"></omgdi:waypoint>            </bpmndi:BPMNEdge>            <bpmndi:BPMNEdge bpmnElement=\"sid-4EBE8673-726D-47D8-B02A-6A63AEA86DD2\" id=\"BPMNEdge_sid-4EBE8673-726D-47D8-B02A-6A63AEA86DD2\">                <omgdi:waypoint x=\"624.9499999999294\" y=\"176.0\"></omgdi:waypoint>                <omgdi:waypoint x=\"765.0\" y=\"176.0\"></omgdi:waypoint>            </bpmndi:BPMNEdge>            <bpmndi:BPMNEdge bpmnElement=\"sid-2849104E-212F-4940-924A-B0C866942BBB\" id=\"BPMNEdge_sid-2849104E-212F-4940-924A-B0C866942BBB\">                <omgdi:waypoint x=\"394.9499999999995\" y=\"177.28571428571428\"></omgdi:waypoint>                <omgdi:waypoint x=\"524.9999999999985\" y=\"176.35678571428573\"></omgdi:waypoint>            </bpmndi:BPMNEdge>        </bpmndi:BPMNPlane>    </bpmndi:BPMNDiagram></definitions>");
        String deployment = deploymentGateway.deployment(createDeployment);
        System.out.println(deployment);
    }

    @Test
    public void deploymentByJson() {
        CreateDeployment createDeployment = new CreateDeployment();
        createDeployment.setName("xxx");
        createDeployment.setKey("Test");
        createDeployment.setCategory("xxx");
        createDeployment.setJson("{\"nodes\":[{\"id\":\"node-32f5935a-6e11-444f-8692-dc20dc63a6c9\",\"renderKey\":\"startEvent\",\"name\":\"startEvent\",\"label\":\"流程开始\",\"width\":210,\"height\":65,\"ports\":{\"items\":[{\"group\":\"top\",\"id\":\"0498db3b-0afb-4ee6-af5f-23894e4aa16e\"},{\"group\":\"right\",\"id\":\"03929246-49e4-49f2-a25c-3acef40b10a1\"},{\"group\":\"bottom\",\"id\":\"8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2\"},{\"group\":\"left\",\"id\":\"6b5a79c5-9785-488d-8908-2d143d8bb54c\"}]},\"isCustom\":true,\"parentKey\":\"base\",\"x\":80,\"y\":50,\"zIndex\":10,\"incomingEdges\":null,\"outgoingEdges\":[{\"shape\":\"edge\",\"id\":\"node-32f5935a-6e11-444f-8692-dc20dc63a6c9:8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2-node-4755a8c3-2642-48cd-b21c-73ef1b172795:837a3c73-f635-4a0e-8de9-6b3cc8d821a6\",\"targetPortId\":\"837a3c73-f635-4a0e-8de9-6b3cc8d821a6\",\"sourcePortId\":\"8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2\",\"zIndex\":1,\"source\":{\"cell\":\"node-32f5935a-6e11-444f-8692-dc20dc63a6c9\",\"port\":\"8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2\"},\"target\":{\"cell\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795\",\"port\":\"837a3c73-f635-4a0e-8de9-6b3cc8d821a6\"},\"labels\":[]}],\"formKey\":\"3577a5f4bdc43fae5cc91f05bbbbff23\",\"_order\":0},{\"id\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795\",\"renderKey\":\"webHookEvent\",\"name\":\"webHookEvent\",\"label\":\"钩子事件\",\"width\":210,\"height\":65,\"ports\":{\"items\":[{\"group\":\"top\",\"id\":\"837a3c73-f635-4a0e-8de9-6b3cc8d821a6\"},{\"group\":\"right\",\"id\":\"dc51c735-184f-4f09-830e-a599cc2ffdea\"},{\"group\":\"bottom\",\"id\":\"ca62a7f0-daab-4577-9c43-055815c2de9c\"},{\"group\":\"left\",\"id\":\"22652aa6-5578-4807-93dd-8a07fdc2e953\"}]},\"isCustom\":true,\"parentKey\":\"event\",\"x\":80,\"y\":180,\"zIndex\":10,\"incomingEdges\":[{\"shape\":\"edge\",\"id\":\"node-32f5935a-6e11-444f-8692-dc20dc63a6c9:8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2-node-4755a8c3-2642-48cd-b21c-73ef1b172795:837a3c73-f635-4a0e-8de9-6b3cc8d821a6\",\"targetPortId\":\"837a3c73-f635-4a0e-8de9-6b3cc8d821a6\",\"sourcePortId\":\"8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2\",\"zIndex\":1,\"source\":{\"cell\":\"node-32f5935a-6e11-444f-8692-dc20dc63a6c9\",\"port\":\"8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2\"},\"target\":{\"cell\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795\",\"port\":\"837a3c73-f635-4a0e-8de9-6b3cc8d821a6\"},\"labels\":[]}],\"outgoingEdges\":[{\"shape\":\"edge\",\"id\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795:ca62a7f0-daab-4577-9c43-055815c2de9c-node-cdc61dec-3b06-48fa-bd39-8bba7f18223a:36bbec70-dc53-4660-8128-34df67ac9005\",\"targetPortId\":\"36bbec70-dc53-4660-8128-34df67ac9005\",\"sourcePortId\":\"ca62a7f0-daab-4577-9c43-055815c2de9c\",\"zIndex\":1,\"source\":{\"cell\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795\",\"port\":\"ca62a7f0-daab-4577-9c43-055815c2de9c\"},\"target\":{\"cell\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a\",\"port\":\"36bbec70-dc53-4660-8128-34df67ac9005\"},\"labels\":[]}],\"requestMethod\":\"POST\",\"contentType\":\"application/json\",\"requestUrl\":\"http://localhost:9989/workflow/webhook\",\"failStatusCodes\":\"400,401,403,500\",\"handleStatusCodes\":\"200\",\"_order\":0,\"requestBody\":\"{\\n\\\\\\\"test\\\\\\\":${approval}\\n}\"},{\"id\":\"node-6e48965d-adec-4614-b057-cbe60069a3de\",\"renderKey\":\"endEvent\",\"name\":\"endEvent\",\"label\":\"流程结束\",\"width\":210,\"height\":65,\"ports\":{\"items\":[{\"group\":\"top\",\"id\":\"f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\"},{\"group\":\"right\",\"id\":\"04fda810-c805-4eb3-a571-09e97533ef24\"},{\"group\":\"bottom\",\"id\":\"4b8b91f1-fca6-4756-9558-c15a3d42a908\"},{\"group\":\"left\",\"id\":\"5d1f0a42-5668-46db-9350-b8fedcb593c8\"}]},\"isCustom\":true,\"parentKey\":\"base\",\"x\":80,\"y\":440,\"zIndex\":10,\"incomingEdges\":[{\"shape\":\"edge\",\"id\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a:c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3-node-6e48965d-adec-4614-b057-cbe60069a3de:f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\",\"targetPortId\":\"f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\",\"sourcePortId\":\"c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3\",\"zIndex\":1,\"source\":{\"cell\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a\",\"port\":\"c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3\"},\"target\":{\"cell\":\"node-6e48965d-adec-4614-b057-cbe60069a3de\",\"port\":\"f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\"},\"labels\":[]}],\"outgoingEdges\":null,\"_order\":0},{\"id\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a\",\"renderKey\":\"scsBinderEvent\",\"name\":\"scsBinderEvent\",\"label\":\"MQ消息\",\"width\":210,\"height\":65,\"ports\":{\"items\":[{\"group\":\"top\",\"id\":\"36bbec70-dc53-4660-8128-34df67ac9005\"},{\"group\":\"right\",\"id\":\"83fd85cc-301e-455f-8378-1db19f0e4c51\"},{\"group\":\"bottom\",\"id\":\"c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3\"},{\"group\":\"left\",\"id\":\"fa49da11-c971-476b-b191-e9d82f726f98\"}]},\"isCustom\":true,\"parentKey\":\"event\",\"x\":80,\"y\":310,\"zIndex\":10,\"incomingEdges\":[{\"shape\":\"edge\",\"id\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795:ca62a7f0-daab-4577-9c43-055815c2de9c-node-cdc61dec-3b06-48fa-bd39-8bba7f18223a:36bbec70-dc53-4660-8128-34df67ac9005\",\"targetPortId\":\"36bbec70-dc53-4660-8128-34df67ac9005\",\"sourcePortId\":\"ca62a7f0-daab-4577-9c43-055815c2de9c\",\"zIndex\":1,\"source\":{\"cell\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795\",\"port\":\"ca62a7f0-daab-4577-9c43-055815c2de9c\"},\"target\":{\"cell\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a\",\"port\":\"36bbec70-dc53-4660-8128-34df67ac9005\"},\"labels\":[]}],\"outgoingEdges\":[{\"shape\":\"edge\",\"id\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a:c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3-node-6e48965d-adec-4614-b057-cbe60069a3de:f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\",\"targetPortId\":\"f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\",\"sourcePortId\":\"c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3\",\"zIndex\":1,\"source\":{\"cell\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a\",\"port\":\"c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3\"},\"target\":{\"cell\":\"node-6e48965d-adec-4614-b057-cbe60069a3de\",\"port\":\"f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\"},\"labels\":[]}],\"binding\":\"versionPublish\",\"body\":\"{\\n\\\\\\\"xxx\\\\\\\":\\\\\\\"xxx\\\\\\\"\\n}\",\"_order\":0}],\"edges\":[{\"id\":\"node-32f5935a-6e11-444f-8692-dc20dc63a6c9:8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2-node-4755a8c3-2642-48cd-b21c-73ef1b172795:837a3c73-f635-4a0e-8de9-6b3cc8d821a6\",\"targetPortId\":\"837a3c73-f635-4a0e-8de9-6b3cc8d821a6\",\"sourcePortId\":\"8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2\",\"source\":{\"cell\":\"node-32f5935a-6e11-444f-8692-dc20dc63a6c9\",\"port\":\"8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2\"},\"target\":{\"cell\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795\",\"port\":\"837a3c73-f635-4a0e-8de9-6b3cc8d821a6\"},\"attrs\":{\"line\":{\"stroke\":\"#A2B1C3\",\"targetMarker\":{\"name\":\"block\",\"width\":12,\"height\":8},\"strokeDasharray\":\"5 5\",\"strokeWidth\":1}},\"zIndex\":1,\"sourcePort\":\"8f413597-fa82-4a3b-94eb-8a6e4cb5c1e2\",\"targetPort\":\"837a3c73-f635-4a0e-8de9-6b3cc8d821a6\"},{\"id\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795:ca62a7f0-daab-4577-9c43-055815c2de9c-node-cdc61dec-3b06-48fa-bd39-8bba7f18223a:36bbec70-dc53-4660-8128-34df67ac9005\",\"targetPortId\":\"36bbec70-dc53-4660-8128-34df67ac9005\",\"sourcePortId\":\"ca62a7f0-daab-4577-9c43-055815c2de9c\",\"source\":{\"cell\":\"node-4755a8c3-2642-48cd-b21c-73ef1b172795\",\"port\":\"ca62a7f0-daab-4577-9c43-055815c2de9c\"},\"target\":{\"cell\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a\",\"port\":\"36bbec70-dc53-4660-8128-34df67ac9005\"},\"attrs\":{\"line\":{\"stroke\":\"#A2B1C3\",\"targetMarker\":{\"name\":\"block\",\"width\":12,\"height\":8},\"strokeDasharray\":\"5 5\",\"strokeWidth\":1}},\"zIndex\":1,\"sourcePort\":\"ca62a7f0-daab-4577-9c43-055815c2de9c\",\"targetPort\":\"36bbec70-dc53-4660-8128-34df67ac9005\"},{\"id\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a:c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3-node-6e48965d-adec-4614-b057-cbe60069a3de:f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\",\"targetPortId\":\"f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\",\"sourcePortId\":\"c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3\",\"source\":{\"cell\":\"node-cdc61dec-3b06-48fa-bd39-8bba7f18223a\",\"port\":\"c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3\"},\"target\":{\"cell\":\"node-6e48965d-adec-4614-b057-cbe60069a3de\",\"port\":\"f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\"},\"attrs\":{\"line\":{\"stroke\":\"#A2B1C3\",\"targetMarker\":{\"name\":\"block\",\"width\":12,\"height\":8},\"strokeDasharray\":\"5 5\",\"strokeWidth\":1}},\"zIndex\":1,\"sourcePort\":\"c937ca5f-5f9f-47fd-ba51-69ad2bdfadf3\",\"targetPort\":\"f9bf4863-eb7c-4ff4-bc9a-db4b4d5c42e2\"}]}");
        BpmnXMLConverter converter = new BpmnXMLConverter();
        String s = StrUtil.utf8Str(converter.convertToXML(createDeployment.getBpmnModel()));
        System.out.println(s);
    }

    public static void main(String[] args) {
        new DeploymentGatewayTest().deploymentByJson();
    }

    @Test
    public void destroy() {
    }
}